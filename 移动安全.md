# 移动App安全审计实践

> 整理

### 审计范围

**设备安全。** 设备被root、被安装恶意软件后对我的App可能存在的安全问题，如进程注入、调试等。
**应用安全。** App在启动初始化、运行及结束过程中可能存在安全问题，如敏感信息泄露、未做HTTPS证书检查、未对关键信息完整性做保护等

### 漏洞危害等级评定说明

**高风险**：
- 直接获取目标核心数据的漏洞
- 越权控制重要业务逻辑的漏洞
- 在一定条件下可影响客户资金安全的漏洞
- 较为严重的合规性问题
- 突破系统原有安全控制措施的漏洞

**中风险**
- 越权控制部分非核心业务逻辑
- 一般的合规性问题
- 利用难度较大的客户端安全漏洞（如反射型XSS）

**低风险**
- 非常苛刻条件下才能够获取控制权的漏洞
- 不能直接造成危害的信息泄露漏洞

### 漏洞可利用性定性分析说明
**容易**
- 有公开的利用工具和攻击代码
- 无需登录手机银行系统即可利用 
- 无需和被攻击用户交互即可利用
- 本地修改数据封包或客户端程序即可利用

**一般**
- 需要和目标用户交互才能够利用
- 通过网络远程抓取目标用户数据包才能够利用

**困难**
- 需要控制被攻击用户的手机才能利用的漏洞
- 需要知道被攻击用户的账号密码才能利用的漏洞

### 应用安全
#### 1、应用本地文件明文存储登录密码和手势密码**
**漏洞描述 **
应用本地文件明文存储了登录密码和手势密码。

**可利用场景 **
恶意程序通过系统漏洞提升权限，读取应用本地文件数据。

** 可利用性 **
一般

**风险等级 **
高风险

**修复建议：建议不存储登录密码或对要存储的密码进行加密处理。**

#### 2、错误密码登录次数不受限制

**漏洞描述 **
账户登录时，错误密码尝试次数不受限制。

**可利用场景 **
暴力破解。

**可利用性 **
容易

**风险等级 **
高风险

**建议服务端对错误密码登录次数做限制，同时可增加动态验证码机制。**

#### 3、SessionToken信息可被网络嗅探

**漏洞描述 **
客户端发送的http协议报文数据含有token信息容易被中间人攻击窃取。

**可利用场景 **
中间人攻击/网络嗅探
**可利用性 **
容易
**风险等级 **
高风险

**建议不向服务器返回Referer，或者都是用https协议。**

#### 4、https链接可转换为http链接

**漏洞描述 **
https协议的报文数据可修改成80端口的http协议报文数据，服务端返回正常的响应。

**可利用场景 **
中间人攻击，将https链接强制转换为http链接

**可利用性 **
容易

**风险等级 **
高风险

**建议服务端关闭80端口**

#### 5、系统日志信息泄露

**漏洞描述 **
在执行密码找回操作时，客户端请求短信验证码，而服务端将短信验证码明文返回给客户端程序。

**可利用场景 **
通过服务端返回的短信验证码，修改任意账户密码。

** 可利用性 **
一般

**风险等级 **
高风险

**建议关闭日志信息输出**

#### 6、JS脚本代码注释未清除

**漏洞描述 **
服务端传递给客户端的JS脚本代码注释未清除

**可利用场景 **
通过代码注释可以辅助分析JS函数代码执行流程。

**可利用性 **
容易

**风险等级 **
低风险

#### 7、JS代码中未清除log输出函数
** 漏洞描述 **
服务端返回的JS代码中含有log输出函数

** 可利用场景 **
泄露程序执行流程、用户敏感信息。

** 可利用性 **
一般

** 风险等级 **
低风险

#### 8、业务信息明文传输

#### 9、重放攻击
** 漏洞描述 **
服务器对客户端的请求缺乏校验，导致客户端请求可以被重放

** 可利用场景 **
不安全的网络环境，攻击者抓取到用户敏感信息后可以直接重放或者篡改伪造后重放请求，如遍历获取用户敏感信息

> 遍历保单信息
>> 通过替换caseNo,重放保单查询报文，即可得到对应的保单信息。

>用户名可被枚举攻击
>>黑客可自动化的枚举手机号码，根据服务端返回的信息判断该号码是否已注册，获得注册账号后，在尝试撞库攻击。

** 可利用性 **
容易

** 风险等级 **
高风险

**建议服务端对客户端发送的请求进行身份验证和权限限制。**

#### 10、手势密码可被任意设置和取消（服务端验证）

**漏洞描述**
手势密码设置和取消的时候虽然有安全验证，但是通过网络传输的数据可以被篡改，从而使设置和取消操作可以绕过安全机制。

**可利用场景**
绕过手势密码
- 关闭手势密码时，需要输入登录密码，这里输入错误的登录密码，通过修改服务器返回数据可以强制取消手势密码。
- 输入任意密码，服务器返回的加密数据
- 解密后的数据，可以看到验证结果是false
- 我们将验证结果的标记false改成true，即可欺骗本地app误以为服务器通过验证，可以看到手势密码成功取消了。

**可利用性**
一般

**风险等级**
高

#### 11、任意用户密保问题直接重置 （服务端验证）

**漏洞描述**
服务端对修改找回密保问题的接口调用未做检测，导致客户端可以伪造请求，直接修改用户的密保问题，结合* 手势密码可被任意设置和取消漏洞*，可以修改任意用户的密保问题。

**可利用场景**
修改任意用户密保问题

**可利用性**
容易

**风险等级**
高

#### 12、找回支付密码，验证码绕过
**漏洞描述**
找回支付密码的时候，虽然会经过手机验证码的验证，但是服务器端没有状态检测，我们修改服务器的响应结果，欺骗客户端，让app进入下一个界面，让app直接调用到找回支付界面的接口，而服务器缺少对用户状态的检测，导致直接重置支付密码。

**可利用场景**
利用密保问题重置的漏洞，然后加上本漏洞，就可以直接重置客户的支付密码

++how？++

**可利用性**
容易

**风险等级**
高

####13、任意用户登陆密码直接重置
**漏洞描述**
用户忘记密码后，可以使用“忘记密码”功能，输入正确的验证码和**密保问题**后可以进入重置登陆密码的界面，该功能会使用一个重置用户密码的接口，用户在调用该接口的时候，服务端未判断用户有没有通过前面的验证，导致可以被伪造，用户直接调用该接口，就可以直接重置任意用户密码。

**可利用场景**
重置任意用户密码

**可利用性**
容易

**风险等级**
高

#### 14、任意用户支付密码直接重置
**漏洞描述**
在找回支付密码的功能中，用户通过验证后，可以直接输入新密码重置支付密码，该服务器接口在后台未做严格的验证，导致可以被**伪造请求**，直接重置用户支付密码，结合报告中其它漏洞，可以直接重置任意用户支付密码。
可利用场景
重置任意用户支付密码

可利用性
容易

风险等级
高

#### 15、完整性校验算法可被绕过
**漏洞描述**
数据在传输过程中的完整性校验算法太简单，可以被绕过

**可利用场景**
伪造网络数据

**可利用性**
一般

**风险等级**
高

**建议：**
对尽量多的数据计算哈希，对签名再使用非对称加密算法加密。

#### 13、登陆验证码本地生成和验证
**漏洞描述**
登陆时，如果几次输入错误的密码，会要求输入验证码，不过该验证码在本地生成和验证，存在一定风险。

**可利用场景**
攻击者可以直接绕过验证码机制，带来安全隐患
> 通过ida分析，可以看到验证码是在本地比对。

**可利用性**
容易

**风险等级**
高


### 设备安全
#### 1、客户端程序可被反编译
** 漏洞描述 **： 相对于编译而言的，它是将二进制程序转换成人们易读的一种描述语言的形式，是逆向工程中的常见手段。
** 可利用场景 **： 逆向工程分析程序运行原理、漏洞挖掘，植入恶意代码等。暴露了客户端的所有逻辑，比如与服务端的通讯方式，加解密算法、密钥，转账业务流程、软键盘技术实现等等。
** 可利用性 **：容易
** 风险等级 **：中风险

**使用代码混淆。**

#### 2、客户端程序可被篡改/二次打包  （Android）
** 漏洞描述 **
客户端程序可被篡改/二次打包。

** 可利用场景 **
逆向工程，资源文件替换、代码植入。

** 可利用性 **
容易

** 风险等级 **
中

**修复建议：建议程序运行时做程序完整性检查。**

#### 3、客户端程序可被动态调试和注入
** 漏洞描述 **
检查客户端软件运行时是否可以被动态调试。

** 可利用场景 **
攻击者利用调试器跟踪目标程序运行，查看、修改内存代码和数据，分析程序逻辑，进行攻击和破解等行为。对于金融行业客户端，该风险可修改客户端业务操作时的数据，比如账号、金额等。

** 可利用性 **
一般

** 风险等级 **
中风险

**修复建议：**
- 建议应用程序运行时检测调试器，如果检测到自身被调试，终止运行。
- 或 越狱检查

#### 4、客户端程序未对设备进行越狱检测
** 漏洞描述 **
客户端程序运行时未对设备进行越狱检测。

** 可利用场景 **
在越狱后的环境中，攻击者可以直接注入恶意代码到本进程空间，影响客户资金安全。

** 可利用性 **
一般

** 风险等级 **
中

**修复建议：**
 越狱检查

#### 5、未使用软盘保护用户敏感信息输入
** 漏洞描述 **
账户登录密码输入时未使用软件盘保护用户输入的敏感数据。

** 可利用场景 **
恶意程序劫持系统键盘窃取用户输入信息；恶意截屏/录屏用户输入过程。

**可利用性**
困难

**风险等级**
中风险

#### 6、界面劫持（Android）
**漏洞描述**
App运行时，activity可以被劫持 

**可利用场景**
钓鱼攻击

**可利用性**
容易

**风险等级**
高


#### 客户端远程代码执行漏洞
**漏洞描述:**
Android客户端调用Webview控件的addJavascriptInterface方法使JS与本地JAVA对象交互。该方法存在安全隐患，从Android SDK4.2(API17)开始已经被JavascriptInterface方法取代。并且客户端程序没有对传入的URL进行合法性判断，如果访问了恶意的JS代码，利用该漏洞可能导致恶意代码执行。

**可利用场景:**
攻击者通过中间人劫持等方式向客户端程序发送了恶意的JS代码，可能导致用户Android手机被植入后门。

**可利用性:**
一般

**风险等级:**
高风险

**修复建议:**
该漏洞产生的原因是因为Android自身的接口存在问题，我们给出如下的整改建议：
1. 避免使用addJavascriptInterface方法，或采用Android SDK4.4及以上版本开发；
2. 在相关类的构造函数中添加相关代码，禁止反射调用
